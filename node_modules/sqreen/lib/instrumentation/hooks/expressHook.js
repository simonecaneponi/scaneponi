/**
 * Copyright (c) 2016 Sqreen. All Rights Reserved.
 * Please refer to our terms for more information: https://www.sqreen.io/terms.html
 */
'use strict';
const Patcher = require('../patcher');
const Modules = Patcher.savedModules;
const ns = require('./util').getNS();
const Shimmer = require('shimmer');
const Util = require('./util');

module.exports = function (identity, module) {

    if (!Modules['express:lib/router/layer.js']) {
        return;
    }

    const hasCookieParser = Util.hasCookieParser();

    // for lazyrouter see https://github.com/expressjs/express/blob/c087a45b9cc3eb69c777e260ee880758b6e03a40/lib/application.js#L137
    const lazyrouter = module.application.lazyrouter;
    const use = module.application.use;
    if (!hasCookieParser) {
        module.application.lazyrouter = function () {

            const res = lazyrouter.apply(this, arguments);
            if (!this.hasSqreenMiddleware) {
                this._router.use(Util.sqreenMiddleWare);
                this.hasSqreenMiddleware = true;
            }
            return res;
        };
    }
    else {
        module.application.use = function () {

            if (!this.hasSqreenMiddleware) {
                if (arguments[0].name === 'cookieParser') {
                    const result = use.apply(this, arguments);
                    use.apply(this, [Util.sqreenMiddleWare]);
                    this.hasSqreenMiddleware = true;
                    return result;
                }
            }
            return use.apply(this, arguments);
        };
    }


    for (let i = 0; i < Modules['express:lib/router/layer.js'].length; ++i) {

        if (!Modules['express:lib/router/layer.js'][i].module || !Modules['express:lib/router/layer.js'][i].module.prototype || !Modules['express:lib/router/layer.js'][i].module.prototype.handle_request) {
            continue;
        }

        Shimmer.wrap(Modules['express:lib/router/layer.js'][i].module.prototype, 'handle_request', (handle_request) => {

            return function (req, res, next) {

                const boundNext = ns.bind(next);

                if (!ns.get('req')) {
                    return ns.run(() => {

                        ns.set('req', req);
                        ns.set('res', res);
                        return handle_request.apply(this, [req, res, boundNext]);
                    });
                }
                return handle_request.apply(this, [req, res, boundNext]);
            };
        });
    }
};
