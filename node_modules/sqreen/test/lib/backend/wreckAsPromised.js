/**
 * Copyright (c) 2016 Sqreen. All Rights Reserved.
 * Please refer to our terms for more information: https://www.sqreen.io/terms.html
 */
'use strict';
const Code = require('code');
const Lab = require('lab');
const lab = exports.lab = Lab.script();

const describe = lab.describe;
const it = lab.it;
const expect = Code.expect;

const WAP = require('../../../lib/backend/wreckAsPromised');

const defaultHeaders = {
    accept: 'application/json',
    'content-type': 'application/json'
};

describe('WAP', () => {

    describe('_writeError', () => {

        it('should write errors', { plan: 2 }, (done) => {

            expect(WAP._writeError(500).code).to.equal('Internal Server Error');
            expect(WAP._writeError(1492).code).to.equal(1492);
            done();
        });
    });

    describe('_assignHeaders', () => {

        it('should assign headers', { plan: 2 }, (done) => {

            expect(WAP._assignHeaders({})).to.equal(defaultHeaders);
            const aaHeaders = defaultHeaders;
            aaHeaders.X = 'aa';
            expect(WAP._assignHeaders({ headers: { X: 'aa' } })).to.equal(aaHeaders);
            done();
        });
    });

    describe('_handleResponse', () => {

        it('should handle new errors', { plan: 1 }, (done) => {

            const handle = WAP._handleResponse(() => null, (err) => {

                expect(err).to.exist();
                done();
            });
            handle({ isBoom: true });
        });

        it('should handle new errors', { plan: 1 }, (done) => {

            const handle = WAP._handleResponse(() => null, (err) => {

                expect(err).to.exist();
                done();
            });
            handle({ isBoom: true, output: { statusCode: 500, payload: {} } });
        });

        it('should _handleResponse', { plan: 1 }, (done) => {

            const handle = WAP._handleResponse(() => null, (err) => {

                expect(err).to.exist();
                done();
            });
            handle({});
        });

        it('should _handleResponse', { plan: 1 }, (done) => {

            const handle = WAP._handleResponse(() => null, (err) => {

                expect(err).to.exist();
                done();
            });
            handle(null, { statusCode: 500 });
        });

        it('should _handleResponse', { plan: 1 }, (done) => {

            const handle = WAP._handleResponse((payload) => {

                expect(payload).to.exist();
                done();
            }, () => null);
            handle(null, { statusCode: 200 }, {});
        });
    });

    describe('GET', () => {

        const Wreck = require('wreck');

        it('should get', { plan: 1 }, (done) => {

            const get = Wreck.__proto__.get;
            Wreck.__proto__.get = function (uri) {

                expect(uri).to.equal('uri');
                Wreck.__proto__.get = get;
                done();
            };
            WAP.GET('uri', {});
        });
    });

    describe('POST', () => {

        const Wreck = require('wreck');

        it('should post', { plan: 1 }, (done) => {

            const get = Wreck.__proto__.post;
            Wreck.__proto__.post = function (uri) {

                expect(uri).to.equal('uri');
                Wreck.__proto__.post = get;
                done();
            };
            WAP.POST('uri', {}, {});
        });

        it('should post', { plan: 1 }, (done) => {

            const get = Wreck.__proto__.post;
            Wreck.__proto__.post = function (uri) {

                expect(uri).to.equal('uri');
                Wreck.__proto__.post = get;
                done();
            };
            WAP.POST('uri', {}, '');
        });

        it('should not post', { plan: 1 }, (done) => {

            const obj = {};
            obj.x = obj;
            WAP.POST('uri', {}, obj)
                .catch((err) => {

                    expect(err).to.exist();
                    done();
                });
        });
    });

});
