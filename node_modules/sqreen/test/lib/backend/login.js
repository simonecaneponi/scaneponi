/**
 * Copyright (c) 2016 Sqreen. All Rights Reserved.
 * Please refer to our terms for more information: https://www.sqreen.io/terms.html
 */
'use strict';
const Code = require('code');
const Lab = require('lab');
const lab = exports.lab = Lab.script();

const describe = lab.describe;
const it = lab.it;
const expect = Code.expect;

const Proxyquire = require('proxyquire');

const Login = require('../../../lib/backend/login');

describe('Backend.login', () => {

    describe('getPayload', () => {

        it('should read the conf of sqreen package', { plan: 3 }, () => {

            return Login.getPayload()
                .then((payload) => {

                    expect(payload).to.exist();
                    expect(payload.various_infos.app_name).to.equal('sqreen');
                    expect(new Date() - new Date(payload.various_infos.time)).to.be.below(10);
                });
        });

        it('should read the conf of sqreen package even without dependencies', { plan: 4 }, () => {

            const MockedLogin = Proxyquire('../../../lib/backend/login', {
                '../package-reader': {
                    getDependencies: function () {

                        return Promise.reject('err');
                    }
                }
            });

            return MockedLogin.getPayload()
                .then((payload) => {

                    expect(payload).to.exist();
                    expect(payload.various_infos.app_name).to.equal('sqreen');
                    expect(new Date() - new Date(payload.various_infos.time)).to.be.below(10);
                    expect(payload.bundle_signature).to.have.length(40);
                });
        });

        it('should read the conf of sqreen package even without proper package', { plan: 4 }, () => {

            const MockedLogin = Proxyquire('../../../lib/backend/login', {
                '../package-reader': {
                    getDependencies: function () {

                        return Promise.reject('err');
                    },
                    readPackage: function () {

                        return {};
                    }
                }
            });

            return MockedLogin.getPayload()
                .then((payload) => {

                    expect(payload).to.exist();
                    expect(payload.various_infos.app_name).to.equal(null);
                    expect(new Date() - new Date(payload.various_infos.time)).to.be.below(10);
                    expect(payload.bundle_signature).to.have.length(40);
                });
        });
    });

    describe('_buildPayload', () => {

        it('should not read a non existing file', { plan: 3 }, (done) => {

            const baseRoot = process.cwd();
            process.chdir('./test');
            const result = Login._buildPayload([]);
            expect(result).to.exist();
            expect(result.various_infos.app_name).to.not.exist();
            expect(result.various_infos.app_version).to.not.exist();
            process.chdir(baseRoot);
            done();
        });

        it('should build even in stupid environments', { plan: 4 }, (done) => {

            const geteuid = process.geteuid;
            const getegid = process.getegid;
            const getuid = process.getuid;
            const getgid = process.getgid;

            process.geteuid = null;
            process.getegid = null;
            process.getuid = null;
            process.getgid = null;

            const payload = Login._buildPayload([]);

            expect(payload.euid).to.not.exist();
            expect(payload.egid).to.not.exist();
            expect(payload.uid).to.not.exist();
            expect(payload.gid).to.not.exist();

            process.geteuid = geteuid;
            process.getegid = getegid;
            process.getuid = getuid;
            process.getgid = getgid;
            done();
        });
    });
});

