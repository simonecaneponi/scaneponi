/**
 * Copyright (c) 2016 Sqreen. All Rights Reserved.
 * Please refer to our terms for more information: https://www.sqreen.io/terms.html
 */
'use strict';
const Code = require('code');
const Lab = require('lab');
const lab = exports.lab = Lab.script();

const describe = lab.describe;
const it = lab.it;
const expect = Code.expect;

const Proxyquire = require('proxyquire');


describe('Hook', () => {

    describe('passportSimple', () => {

        it('should make the strategy instrumented', { plan: 2 }, (done) => {

            let ctr = 0;
            const MockedHook = Proxyquire('../../../../lib/instrumentation/hooks/passportSimpleHook', {
                '../sqreenDirector': {
                    update: function (payload) {

                        expect(payload.moduleName).to.equal('passport-local');
                        const fct = payload.params.preCbs[0].method;
                        fct(() => ({}));
                    }
                },
                '../functionPatcher': {
                    patchFunction: function () {

                        ctr++;
                        if (ctr > 1) {
                            done();
                        }
                    }
                }
            });
            MockedHook({ version: '0.1.0' });
            MockedHook({ version: '0.1.0', name: 'passport-local' });
        });
    });
});
