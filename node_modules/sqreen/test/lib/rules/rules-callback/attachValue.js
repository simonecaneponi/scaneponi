/**
 * Copyright (c) 2016 Sqreen. All Rights Reserved.
 * Please refer to our terms for more information: https://www.sqreen.io/terms.html
 */
'use strict';
const Code = require('code');
const Lab = require('lab');
const lab = exports.lab = Lab.script();

const describe = lab.describe;
const it = lab.it;
const expect = Code.expect;

const Post = require('../../../../lib/rules/rules-callback').AttachValueCB().post;

describe('Callback', () => {

    describe('AttachValueCB', () => {

        it('should attach to req', { plan: 3 }, (done) => {

            const value = 10;
            const rule = { data: { values: [{ name: 'claim', claim: 'claim' }] } };

            const session = { req: {} };

            Post(null, value, rule, null, session);

            expect(session.req.__sqreen.claim).to.equal([{ name: 'claim', value: 10 }]);

            Post(null, value, rule, null, session);
            expect(session.req.__sqreen.claim).to.equal([{ name: 'claim', value: 10 }, { name: 'claim', value: 10 }]);

            const noSession = {};
            Post(null, value, rule, null, noSession);
            expect(noSession).to.equal({});

            done();
        });
    });
});
