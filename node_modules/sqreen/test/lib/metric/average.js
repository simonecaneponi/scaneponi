/**
 * Copyright (c) 2016 Sqreen. All Rights Reserved.
 * Please refer to our terms for more information: https://www.sqreen.io/terms.html
 */
'use strict';
const Code = require('code');
const Lab = require('lab');
const lab = exports.lab = Lab.script();
const beforeEach = lab.beforeEach;

const describe = lab.describe;
const it = lab.it;
const expect = Code.expect;

const Metric = require('../../../lib/metric');
const Avg = require('../../../lib/metric/average');

describe('Metric', () => {

    beforeEach((done) => {

        Metric._clearAllMetrics();
        done();
    });

    describe('Avg', () => {

        it('should create an average metric', { plan: 4, timeout: 20000 }, (done) => {

            const avg = new Avg({
                kind: 'Average',
                name: 'login-fail',
                period: 2
            });

            avg.add('key1', 0);
            avg.add('key1', 2);
            avg.add('key2', 1);

            expect(Metric.getMetricByName('login-fail')).to.equal(avg);
            setTimeout(() => {

                avg.add('key1', 10);
                avg.add('key1', 5);
                avg.add('key3', 1);
            }, 3000);

            setTimeout(() => {

                avg.process();
                expect(avg.values.map((x) => x.value)).to.equal([{ 'key1': 1, 'key2': 1 }, { 'key1': 7.5, 'key3': 1 }]);
                expect(avg.observe().map((x) => x.value)).to.equal([{ 'key1': 1, 'key2': 1 }, { 'key1': 7.5, 'key3': 1 }]);
                expect(avg.values.map((x) => x.value)).to.equal([]);
                done();
            }, 6000);

        });
    });

});
